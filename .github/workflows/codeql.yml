name: "CodeQL Coding Standards ONLY"

on:
  pull_request:
    branches: [ "main", "master" ]
  push:
    branches: [ "main", "master" ]

jobs:
  analyze:
    name: Coding Standards Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Checkout CodeQL Coding Standards
      uses: actions/checkout@v4
      with:
        repository: github/codeql-coding-standards
        path: codeql-coding-standards

    - name: Install CodeQL CLI
      run: |
        # Download and install CodeQL CLI
        curl -L -o codeql-linux64.tar.gz "https://github.com/github/codeql-cli-binaries/releases/download/v2.22.0/codeql-linux64.tar.gz"
        tar -xzf codeql-linux64.tar.gz
        echo "$PWD/codeql" >> $GITHUB_PATH
        
        # Verify installation
        ./codeql/codeql version

    - name: Install Coding Standards Dependencies
      run: |
        cd codeql-coding-standards/cpp/common/src && codeql pack install && cd ../../../../
        cd codeql-coding-standards/cpp/cert/src && codeql pack install && cd ../../../../
        cd codeql-coding-standards/cpp/autosar/src && codeql pack install && cd ../../../../

    - name: Create CodeQL Database
      run: |
        if [ -f "Makefile" ]; then
          codeql database create codeql-db --language=cpp --command="make"
        else
          codeql database create codeql-db --language=cpp --command="find . -name '*.c' -exec gcc -c {} \;"
        fi

    - name: Run CERT C++ Coding Standards
      run: |
        codeql database analyze codeql-db \
          ./codeql-coding-standards/cpp/cert/src \
          --format=sarif-latest \
          --output=cert-results.sarif \
          --sarif-category=cert-cpp

    - name: Run AUTOSAR C++ Coding Standards
      run: |
        codeql database analyze codeql-db \
          ./codeql-coding-standards/cpp/autosar/src \
          --format=sarif-latest \
          --output=autosar-results.sarif \
          --sarif-category=autosar-cpp

    - name: Upload CERT Results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: cert-results.sarif
        category: cert-cpp

    - name: Upload AUTOSAR Results  
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: autosar-results.sarif
        category: autosar-cpp

    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const message = "## CodeQL Coding Standards Analysis\n\n" +
            "**CERT C++ Secure Coding Standards**: ✅\n" +
            "**AUTOSAR C++ Automotive Standards**: ✅\n\n" +
            "View results in the [Security tab](" + context.payload.repository.html_url + "/security/code-scanning).";
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
